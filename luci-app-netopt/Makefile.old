################################################################################
# OpenWrt/LEDE Makefile for luci-app-netopt (all-in-one)
# 
# Complete package including both LuCI interface and netopt backend
################################################################################

include $(TOPDIR)/rules.mk

# Package metadata
PKG_NAME:=luci-app-netopt
PKG_VERSION:=1.0.0
PKG_RELEASE:=1

# Maintainer info
PKG_MAINTAINER:=Your Name <your@email.com>
PKG_LICENSE:=GPL-2.0-only
PKG_LICENSE_FILES:=LICENSE

# Include LuCI build system
LUCI_TYPE:=app
LUCI_PKGARCH:=all

include $(TOPDIR)/feeds/luci/luci.mk

# Package definition
LUCI_TITLE:=Network Optimization Interface
LUCI_DESCRIPTION:=Complete network optimization tool with web interface

# Build/Prepare
define Build/Prepare
	# For all-in-one package, files are in source directory
	$(CP) ./src/* $(PKG_BUILD_DIR)/
endef

# Build/Configure (if needed)
define Build/Configure
endef

# Build/Compile (if needed)
define Build/Compile
endef

# Installation rules - installs everything in one go
define Package/luci-app-netopt/install
	# ========== 1. 安装配置文件 ==========
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_CONF) ./root/etc/config/netopt $(1)/etc/config/
	
	# ========== 2. 安装启动脚本 ==========
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) ./root/etc/init.d/netopt $(1)/etc/init.d/
	
	# ========== 3. 安装 RPC 脚本 ==========
	$(INSTALL_DIR) $(1)/usr/libexec/rpcd
	$(INSTALL_BIN) ./root/usr/libexec/rpcd/netopt $(1)/usr/libexec/rpcd/
	
	# ========== 4. 安装 RPC ACL 权限文件 ==========
	$(INSTALL_DIR) $(1)/usr/share/rpcd/acl.d
	$(INSTALL_DATA) ./root/usr/share/rpcd/acl.d/luci-app-netopt.json \
		$(1)/usr/share/rpcd/acl.d/
	
	# ========== 5. 安装 LuCI 菜单配置 ==========
	$(INSTALL_DIR) $(1)/usr/share/luci/menu.d
	$(INSTALL_DATA) ./root/usr/share/luci/menu.d/luci-app-netopt.json \
		$(1)/usr/share/luci/menu.d/
	
	# ========== 6. 安装 LuCI 静态资源 ==========
	$(INSTALL_DIR) $(1)/www/luci-static/resources/view/netopt
	$(INSTALL_DATA) ./htdocs/luci-static/resources/view/netopt/overview.js \
		$(1)/www/luci-static/resources/view/netopt/
	
	# ========== 7. 安装控制脚本（可选） ==========
	$(INSTALL_DIR) $(1)/usr/bin
	$(if $(wildcard ./root/usr/bin/netopt), \
		$(INSTALL_BIN) ./root/usr/bin/netopt $(1)/usr/bin/, \
		@echo "No control script found, skipping" \
	)
endef

# Configuration files to preserve during upgrade
define Package/luci-app-netopt/conffiles
/etc/config/netopt
endef

# Post-install script
define Package/luci-app-netopt/postinst
#!/bin/sh
# 只在目标系统上运行，不是在构建系统上
if [ -z "$$IPKG_INSTROOT" ]; then
	# 1. 启用服务
	/etc/init.d/netopt enable >/dev/null 2>&1 || true
	echo "✓ Netopt service enabled for boot"
	
	# 2. 检查并创建默认配置（如果不存在）
	if [ ! -f "/etc/config/netopt" ]; then
		cp -f /tmp/netopt-default-config /etc/config/netopt 2>/dev/null || \
		cat > /etc/config/netopt << 'EOF'
config netopt 'config'
    option enable '0'
    option eee '0'
    option rpsxps '0'
    list interfaces 'eth0'
EOF
		echo "✓ Default configuration created"
	fi
	
	# 3. 重新加载 RPC 服务以识别新脚本
	if [ -f /etc/init.d/rpcd ]; then
		/etc/init.d/rpcd restart >/dev/null 2>&1 || true
	fi
	
	# 4. 清理 LuCI 缓存
	rm -rf /tmp/luci-modulecache /tmp/luci-indexcache 2>/dev/null
	
	# 5. 重启 uhttpd（如果需要）
	if [ -f /etc/init.d/uhttpd ]; then
		/etc/init.d/uhttpd reload >/dev/null 2>&1 || true
	fi
	
	echo " "
	echo "=========================================="
	echo "luci-app-netopt v$(PKG_VERSION) installed!"
	echo "Access via: LuCI → Network → Network Optimization"
	echo "=========================================="
fi
exit 0
endef

# Pre-remove script
define Package/luci-app-netopt/prerm
#!/bin/sh
if [ -z "$$IPKG_INSTROOT" ]; then
	# 停止并禁用服务
	/etc/init.d/netopt disable >/dev/null 2>&1 || true
	/etc/init.d/netopt stop >/dev/null 2>&1 || true
	echo "Netopt service stopped and disabled"
	
	# 清理 LuCI 缓存
	rm -rf /tmp/luci-modulecache /tmp/luci-indexcache 2>/dev/null
fi
exit 0
endef

# Post-remove script
define Package/luci-app-netopt/postrm
#!/bin/sh
if [ -z "$$IPKG_INSTROOT" ]; then
	# 清理临时文件
	rm -f /var/run/netopt.pid 2>/dev/null || true
	rm -f /tmp/netopt.log 2>/dev/null || true
	
	# 重新加载 LuCI
	if [ -f /etc/init.d/uhttpd ]; then
		/etc/init.d/uhttpd restart >/dev/null 2>&1 || true
	fi
fi
exit 0
endef

# Call the build macro
$(eval $(call BuildPackage,luci-app-netopt))
