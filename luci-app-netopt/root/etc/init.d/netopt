#!/bin/sh /etc/rc.common

START=99
STOP=10

USE_PROCD=1

CONFIG=/etc/config/netopt
LOGGER_TAG="netopt-init"

start_service() {
    # 先读取配置看看
    logger -t $LOGGER_TAG "读取配置文件: $CONFIG"
    
    if [ -f "$CONFIG" ]; then
        logger -t $LOGGER_TAG "配置文件内容:"
        cat "$CONFIG" | logger -t $LOGGER_TAG
        
        local interfaces=$(uci -q get netopt.netopt.interfaces 2>/dev/null)
        logger -t $LOGGER_TAG "读取到的接口: '$interfaces'"
    fi
    
    # 等待配置中的接口
    local count=0
    while [ $count -lt 30 ]; do
        local interfaces=$(uci -q get netopt.netopt.interfaces 2>/dev/null | tr -d "'")
        if [ -n "$interfaces" ]; then
            local all_ready=1
            for iface in $interfaces; do
                if [ ! -e "/sys/class/net/$iface" ]; then
                    all_ready=0
                    logger -t $LOGGER_TAG "接口 $iface 不存在"
                    break
                fi
            done
            
            if [ $all_ready -eq 1 ]; then
                logger -t $LOGGER_TAG "所有接口就绪，启动netopt"
                procd_open_instance
                procd_set_param command /usr/bin/netopt-apply
                procd_set_param stdout 1
                procd_set_param stderr 1
                procd_close_instance
                return 0
            fi
        fi
        
        sleep 2
        count=$((count + 1))
    done
    
    logger -t $LOGGER_TAG "超时，强制启动netopt"
    procd_open_instance
    procd_set_param command /usr/bin/netopt-apply
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance
}

stop() {
    logger -t $LOGGER_TAG "netopt服务停止"
}
