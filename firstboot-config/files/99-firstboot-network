#!/bin/sh

LOGTAG="firstboot"

echo "[$LOGTAG] applying firstboot configuration..."

#
# ===== Network firstboot config =====
#
if uci -q get network.lan >/dev/null 2>&1; then
	echo "[$LOGTAG] configuring network..."

	uci batch <<EOF
set network.lan.ipaddr='192.168.1.2'
set network.lan.netmask='255.255.255.0'
add_list network.lan.dns='192.168.1.1'
EOF

	uci commit network
	/etc/init.d/network reload >/dev/null 2>&1

	logger -t "$LOGTAG" "network configured: IP=192.168.1.2 DNS=192.168.1.1"
else
	logger -t "$LOGTAG" "network.lan not found, skip network config"
fi

#
# ===== sing-box user fix (one-time) =====
#
if uci -q get sing-box.main.user >/dev/null 2>&1; then
	CUR_USER="$(uci -q get sing-box.main.user)"

	if [ "$CUR_USER" = "sing-box" ]; then
		uci set sing-box.main.user='root'
		uci commit sing-box
		logger -t "$LOGTAG" "sing-box user fixed: sing-box -> root"
	else
		logger -t "$LOGTAG" "sing-box user already '$CUR_USER', no change"
	fi
else
	logger -t "$LOGTAG" "sing-box config not found, skip user fix"
fi

#
# ===== enable sing-box if present =====
#
if [ -x /etc/init.d/sing-box ]; then
	/etc/init.d/sing-box enable
	logger -t "$LOGTAG" "sing-box enabled"
fi

echo "[$LOGTAG] firstboot configuration completed"

exit 0

